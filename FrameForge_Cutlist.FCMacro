# vim: ft=python

import FreeCAD as App

DOC = App.ActiveDocument

# ---------------- КОНСТАНТЫ ----------------

DEFAULT_MATERIAL = "Профруба"

STOCK_LENGTH = 3000.0
KERF = 2.0

ROUND_TO = 1          # 0.1 мм
MIN_LENGTH = 10.0
MAX_LENGTH = 6000.0

COLOR_HEADER = (0.85, 0.85, 0.85)
COLOR_ROW_A  = (0.96, 0.96, 0.96)
COLOR_ROW_B  = (0.90, 0.90, 0.90)
TEXT_COLOR   = (0.0, 0.0, 0.0)

DEBUG = True


# ---------------- УТИЛИТЫ ----------------

def log(msg):
    if DEBUG:
        App.Console.PrintMessage(str(msg) + "\n")


def get_length(obj):
    bb = obj.Shape.BoundBox
    L = max(bb.XLength, bb.YLength, bb.ZLength)
    return round(L, ROUND_TO)


def get_profile_code(obj):
    name = obj.Name
    parts = name.split("_")
    if len(parts) < 2:
        return None
    if parts[0] != "Profile":
        return None
    return parts[1]


def get_material(obj):
    code = get_profile_code(obj)
    if not code:
        return None
    return f"{DEFAULT_MATERIAL} {code}"


def get_trim(obj, prop):
    if hasattr(obj, prop):
        try:
            v = getattr(obj, prop)
            log(f"{obj.Name}  {prop} = {v}")
            return float(v)
        except:
            pass
    return 0.0


def canonical_key(length, material, a1, a2, r2):
    k1 = (length, material, a1, a2, r2)
    k2 = (length, material, a2, a1, (r2 + 180.0) % 360.0)
    return min(str(k1), str(k2))


def pack_stock(lengths):
    lengths = sorted(lengths, reverse=True)
    stocks = []

    for L in lengths:
        placed = False
        for stock in stocks:
            used = sum(stock) + KERF * (len(stock))
            if used + L <= STOCK_LENGTH:
                stock.append(L)
                placed = True
                break
        if not placed:
            stocks.append([L])

    return stocks


# ---------------- СБОР ДЕТАЛЕЙ ----------------

items = {}

for o in DOC.Objects:

    if not hasattr(o, "Shape"):
        continue
    if not o.Visibility:
        continue

    code = get_profile_code(o)
    if not code:
        continue

    try:
        L = get_length(o)
    except:
        continue

    if L < MIN_LENGTH or L > MAX_LENGTH:
        log(f"SKIP length out of range: {o.Name}  {L}")
        continue

    material = get_material(o)

    a1 = get_trim(o, "TrimAngle1")
    a2 = get_trim(o, "TrimAngle2")
    r2 = get_trim(o, "TrimRotate2")

    log(f"DETAIL: {o.Name}  L={L}  A1={a1}  A2={a2}  R2={r2}")

    key = canonical_key(L, material, a1, a2, r2)

    if key not in items:
        items[key] = {
            "length": L,
            "material": material,
            "a1": a1,
            "a2": a2,
            "r2": r2,
            "qty": 0
        }

    items[key]["qty"] += 1


# ---------------- ТАБЛИЦА ----------------

if "CutList" in DOC.Objects:
    sheet = DOC.getObject("CutList")
    sheet.clearAll()
else:
    sheet = DOC.addObject("Spreadsheet::Sheet", "CutList")

row = 1

# ----- заголовок деталей

headers = ["Материал", "Длина", "A1", "A2", "Rotate2", "Кол-во"]
cols = ["A","B","C","D","E","F"]

for c, h in zip(cols, headers):
    sheet.set(c+str(row), h)
    sheet.setBackground(c+str(row), COLOR_HEADER)
    sheet.setForeground(c+str(row), TEXT_COLOR)

row += 1

sorted_items = sorted(items.values(),
                      key=lambda x: (x["material"], x["length"]))

zebra = False
for it in sorted_items:
    bg = COLOR_ROW_A if zebra else COLOR_ROW_B
    zebra = not zebra

    sheet.set("A"+str(row), it["material"])
    sheet.set("B"+str(row), str(it["length"]))
    sheet.set("C"+str(row), str(it["a1"]))
    sheet.set("D"+str(row), str(it["a2"]))
    sheet.set("E"+str(row), str(it["r2"]))
    sheet.set("F"+str(row), str(it["qty"]))

    for c in cols:
        sheet.setBackground(c+str(row), bg)
        sheet.setForeground(c+str(row), TEXT_COLOR)

    row += 1


# ---------------- РАСКРОЙ ----------------

row += 2
sheet.set("A"+str(row), "РАСКРОЙ")
sheet.setBackground("A"+str(row), COLOR_HEADER)
row += 1

materials = {}

for it in sorted_items:
    mat = it["material"]
    if mat not in materials:
        materials[mat] = []
    materials[mat] += [it["length"]] * it["qty"]

for mat, lengths in materials.items():

    sheet.set("A"+str(row), mat)
    sheet.setBackground("A"+str(row), COLOR_HEADER)
    row += 1

    stocks = pack_stock(lengths)

    hdr = ["Хлыст", "Деталь1", "Деталь2", "Деталь3", "Деталь4", "Деталь5", "Остаток"]
    for i, h in enumerate(hdr):
        col = chr(ord("A")+i)
        sheet.set(col+str(row), h)
        sheet.setBackground(col+str(row), COLOR_HEADER)
        sheet.setForeground(col+str(row), TEXT_COLOR)

    row += 1

    zebra = False
    idx = 1

    for s in stocks:
        bg = COLOR_ROW_A if zebra else COLOR_ROW_B
        zebra = not zebra

        sheet.set("A"+str(row), str(idx))

        col_i = 1
        for part in s:
            col = chr(ord("A")+col_i)
            sheet.set(col+str(row), str(part))
            col_i += 1

        used = sum(s) + KERF * (len(s)-1)
        rest = round(STOCK_LENGTH - used, ROUND_TO)

        sheet.set("G"+str(row), str(rest))

        for i in range(7):
            col = chr(ord("A")+i)
            sheet.setBackground(col+str(row), bg)
            sheet.setForeground(col+str(row), TEXT_COLOR)

        row += 1
        idx += 1


DOC.recompute()
App.Console.PrintMessage("=== DONE ===\n")
